<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>AR Image Debug</title>

    <!-- A-Frame Library -->
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <!-- AR.js Library for Web AR -->
    <script src="https://cdn.rawgit.com/jeromeetienne/AR.js/1.7.5/aframe/build/aframe-ar.min.js"></script>
    <!-- Hammer.js Library for Gesture Recognition -->
    <script src="https://hammerjs.github.io/dist/hammer.min.js"></script>
</head>

<body style="margin: 0; overflow: hidden;">

    <!-- AR Scene - IMPORTANT: debugUIEnabled=true -->
    <a-scene embedded arjs='sourceType: webcam; debugUIEnabled: true;'>

        <!-- Marqueur Hiro -->
        <!-- Le contenu ici n'apparaîtra QUE si le marqueur Hiro est détecté par la caméra -->
        <a-marker preset="hiro">
            <!-- Vérifiez que 'output_visualization.svg' est dans le MEME dossier que ce fichier HTML -->
            <!-- Ou mettez le bon chemin (ex: 'images/output_visualization.svg') -->
            <a-image id="resizableImage"
                     src="output_visualization.svg"
                     position="0 0 0"
                     rotation="-90 0 0"
                     width="1"
                     height="0.75"
                     scale="1 1 1">
             </a-image>

             <!-- Test alternatif si l'image ne s'affiche pas : décommentez la ligne a-box et commentez a-image -->
             <!-- <a-box id="resizableImage" color="tomato" position="0 0.5 0" scale="0.5 0.5 0.5"></a-box> -->

        </a-marker>

         <!-- Caméra fixe -->
        <a-entity camera></a-entity>
    </a-scene>

    <!-- File Input for User to Upload an Image -->
    <div style="position: fixed; top: 10px; left: 10px; z-index: 1;">
        <input type="file" id="imageUpload" accept="image/*" />
    </div>

    <!-- Script for Handling Gestures and Image Upload -->
    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            var image = document.getElementById('resizableImage'); // Peut être a-image ou a-box si vous testez
            if (!image) {
                console.error("L'élément 'resizableImage' n'a pas été trouvé ! Vérifiez l'ID.");
                return;
            }
            console.log("Élément 'resizableImage' trouvé:", image.tagName);

            var isPanning = false;
            var startPosition = null;
            var startScale = null;
            const panSensitivity = 0.003;

            // Hammer.js sur le body
            var mc = new Hammer(document.body);
            mc.get('pinch').set({ enable: true });
            mc.get('pan').set({ direction: Hammer.DIRECTION_ALL, enable: true });

            // --- Pinch Listeners ---
             mc.on('pinchstart', function(ev) {
                if (image && !isPanning) { // Ne pas démarrer pinch si on pan déjà
                    startScale = image.getAttribute('scale');
                     console.log("Pinch Start - Start Scale:", startScale);
                }
             });

            mc.on('pinch', function (ev) {
                if (isPanning || !startScale || !image) return;
                let newScaleFactor = ev.scale;
                image.setAttribute('scale', {
                    x: startScale.x * newScaleFactor,
                    y: startScale.y * newScaleFactor,
                    z: startScale.z // Garder Z constant
                });
            });

             mc.on('pinchend', function(ev) {
                 if (!isPanning) { // Ne pas finir pinch si on a switché en pan
                    startScale = null;
                    console.log("Pinch End");
                 }
             });

            // --- Pan Listeners ---
            mc.on('panstart', function(ev) {
                if (image && !startScale) { // Ne pas démarrer pan si on pinch déjà
                    isPanning = true;
                    startPosition = image.getAttribute('position');
                     console.log("Pan Start - Start Position:", startPosition);
                }
            });

            mc.on('panmove', function (ev) {
                if (!isPanning || !startPosition || !image) return;
                let newX = startPosition.x + ev.deltaX * panSensitivity;
                let newY = startPosition.y; // Reste sur le plan du marqueur
                let newZ = startPosition.z - ev.deltaY * panSensitivity; // Y écran -> Z objet
                image.setAttribute('position', { x: newX, y: newY, z: newZ });
            });

            mc.on('panend', function(ev) {
                if (isPanning) {
                    isPanning = false;
                    startPosition = null;
                    console.log("Pan End");
                }
            });

            // --- Image Upload ---
            var imageUpload = document.getElementById('imageUpload');
            if(imageUpload) {
                imageUpload.addEventListener('change', function (event) {
                    var file = event.target.files[0];
                    if (file && image) {
                        var reader = new FileReader();
                        reader.onload = function (e) {
                            // Important: Si vous testiez avec a-box, il faut re-cibler si l'ID est sur l'image
                            var currentImageElement = document.getElementById('resizableImage');
                            if (currentImageElement.tagName === 'A-IMAGE') {
                                currentImageElement.setAttribute('src', e.target.result);
                                currentImageElement.setAttribute('scale', '1 1 1');
                                currentImageElement.setAttribute('position', '0 0 0');
                                startScale = {x:1, y:1, z:1};
                                console.log("Image chargée et réinitialisée");
                            } else {
                                console.log("Upload: L'élément cible n'est pas une A-IMAGE, src non appliqué.");
                            }
                        };
                        reader.readAsDataURL(file);
                    }
                });
            } else {
                 console.error("Input 'imageUpload' non trouvé !");
            }

            // --- Prevent Default Touch Actions ---
            document.body.addEventListener('touchstart', function(e) {
                if (e.target.tagName !== 'INPUT') e.preventDefault();
            }, { passive: false });
            document.body.addEventListener('touchmove', function(e) {
                e.preventDefault();
            }, { passive: false });

            console.log("Script initialisé.");
        });
    </script>
</body>
</html>
